import AppHelper from 'helpers/AppHelper'
import AuthHelper from 'helpers/AuthHelper'
import AuxiliaryHelper from 'helpers/AuxiliaryHelper'
import CustomerHelper from 'helpers/CustomerHelper'
import InterventionHelper from 'helpers/InterventionHelper'
import ServiceHelper from 'helpers/ServiceHelper'

import { BaseData, Utils } from 'ap-react-bootstrap'


let ICONS = {
	HOME: '/assets/images/markers/gmap-marker-home.png',
	GEOZONE: '/assets/images/markers/gmap-marker-geozone.png',
	OFFER: '/assets/images/markers/gmap-marker-customer-pink.png',
	INTERVENTION: '/assets/images/markers/gmap-marker-customer-blue.png',
	SERVICE: '/assets/images/markers/gmap-marker-service-green.png',
	SERVICE_ANY: '/assets/images/markers/gmap-marker-service-red.png'
}

let INFO_TYPE = {
	HOME: 'H',
	GEOZONE: 'G',
	CUSTOMER: 'C',
	OFFER: 'O',
	SERVICE: 'S'
}

/* This class was auto-generated by the JavaScriptWriter */
class AuxiliaryZoneData extends BaseData {

	register(obj) {
		super.register(obj)
		
		this.onMarkerClicked = this._onMarkerClicked.bind(this)

		this.auxliary = AuxiliaryHelper.getData(AuthHelper.getEntityId())

		this.obj.state = {
			auxliary: this.auxliary,
			centerLattitude: Number(this.auxliary.lattitude),
			centerLongitude: Number(this.auxliary.longitude)
		}

		let test = ServiceHelper.getData()
		this.homeMarkers = [ this.buildHomeMarker() ]
		this.serviceMarkers = this.resolveServices().map(this.buildServiceMarker.bind(this))

		this.obj.state.markers = this.homeMarkers.concat(this.serviceMarkers)
	}

	unregister() {
	}

	_onMarkerClicked(marker) {
		let service = null
		switch(marker.type) {
		case INFO_TYPE.HOME:
			break
		case INFO_TYPE.SERVICE:
			service = ServiceHelper.getData(marker.id)
			break
		}
		this.setState({ 
			infoType: marker.type,
			service: service
		})
	}

	buildHomeMarker() { 
		return {
			lattitude: Number(this.auxliary.lattitude),
			longitude: Number(this.auxliary.longitude),
			title: 'Mon domicile',
			type: INFO_TYPE.HOME,
			icon: ICONS.HOME,
			onClick: this.onMarkerClicked.bind(this)
		}
	}

	buildServiceMarker(service) {
		return {
			id: service.id,
			type: INFO_TYPE.SERVICE,
			lattitude: service.lattitude,
			longitude: service.longitude,
			title: service.socialReason,
			icon: ICONS.SERVICE,
			onClick: this.onMarkerClicked.bind(this)
		}
	}

	resolveServices() {
		let exclude = this.resolveServiceWithIntervention()
		return Utils.reduce(ServiceHelper.getData(), function (services, service) {
			if (exclude.indexOf(service.id) === -1) {
				services.push(service)
			}
			return services
		}, [])
	}

	resolveServiceWithIntervention() {
		return Utils.reduce(InterventionHelper.getData(), function (services, intervention) {
			if (InterventionUtils.isActive(intervention) && services.indexOf(intervention.serviceId) === -1) {
				services.push(intervention.serviceId)
			}
			return services
		}, [])
	}

}
var AuxiliaryZoneObj = new AuxiliaryZoneData()
AuxiliaryZoneObj.ICONS = ICONS
AuxiliaryZoneObj.INFO_TYPE = INFO_TYPE
export default AuxiliaryZoneObj

